#!/bin/sh

PROLOG='@prolog@'
MLPATH='@mlpath@'

BASENAME='@basename@'
BIBTEX='@bibtex@'
CP='@cp@'
LATEX='@latex@'
RM='@rm@'
SED='@sed@'
AWK='@awk@'

LTX='@ltx@'

prg=`$BASENAME $0`

if $LTX
then
  :
else
  echo "$prg: MUltlog was not installed with TeX support"
  exit 1
fi

if [ ! "$1" ]
then
  echo "$prg: Argument (file with specification of logic) missing"
  exit 1
fi

file=`echo $1 | $SED 's/\.lgc$//'`
shift

if [ "$*" ]
then
  echo "$prg: too many arguments ($*)"
  exit
fi

if [ ! -f "$file.lgc" ]
then
  echo "$prg: Specification $file.lgc does not exist."
  exit 1
fi

logfile=$file.mlg

for ext in tex sty aux log bbl blg dvi mlg ilc
do
   if [ -f $file.$ext ]
   then
      $RM -f $file.$ext
   fi
done

if [ ! -f $file.cfg ]
then
   $AWK '/^%/||/^ *$/{next}{print}' $MLPATH/ml.cfg > $file.cfg
fi

$PROLOG -s "$MLPATH/ml" -g "lgc2tex('$file.lgc','$file.sty','$file.cfg'), halt." 2>>$logfile

if [ -f "$file.sty" ]
then
  $CP $MLPATH/ml.tex $file.tex
  $CP $MLPATH/ml.sty .
  $CP $MLPATH/ml.bib .
  $CP $MLPATH/proof.sty .
  echo ""
  echo "LaTeXing $file ..."
  $LATEX  $file >> $logfile </dev/null
  echo "BiBTeXing $file ..."
  $BIBTEX $file >> $logfile </dev/null
  echo "LaTeXing $file ..."
  $LATEX  $file >> $logfile </dev/null
  echo "LaTeXing $file ..."
  $LATEX  $file >> $logfile </dev/null
  if [ -f "$file.dvi" ]
  then
     echo "Cleaning up ..."
     delfiles="$logfile"
     delfiles="$delfiles $file.aux $file.log $file.bbl $file.blg"
     delfiles="$delfiles $file.sty $file.tex ml.sty ml.bib proof.sty $file.lgc.stripped"
     for f in $delfiles
     do
        if [ -f $f ]
        then
           $RM -f $f
        fi
     done
     echo
     echo "Your paper '$file.dvi' is now ready for viewing."
  else
     echo "$prg: Some error happened. See $logfile for more information."
     exit 1
  fi
else
  echo "$prg: Some error happened. See $logfile for more information."
  exit 1
fi
